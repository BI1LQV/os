
This comment is licensed under CC BY-NC-ND 4.0.
Copyright (c) 2022 BI1LQV

我是一名在石油大学读了三年的本科同学，从我的使用体验来看，教务系统三年以来是有进步的（就是不太明显）。

我记得大一第一年抢课的时候，一直白屏，或者好不容易登录进去了，选课的时候又要重新登陆（session失效）。

后来好像这种情况少了一些，但是又出现了登录的时候验证码加载不出来的问题。

再后来有了sso（统一认证登录），问题就进一步得到了优化，大不了从sso登录就行。

通过流程的优化（预选抽签，不需要抢；真正到正选的时候其实并发也不大了）、一些及其缓慢的优化，总体来说现在的教务系统算是进步了很多，不是很容易让人跳脚生气了。

我从动静两方面来讨论这个东西吧。

静态资源是比较简单的，估计一开始nginx这种东西都没用上，静态资源服务和后端服务全写一个东西里了，并发一上来两个一起挂了。

解决方案也很简单，虽然以前流行后端把html全部拼好了直接传给前端（如php jsp之流），但是都2022年了呐，古尔丹，时代变了。今天b/s架构都会把前后端都解耦，前端已经是纯静态的内容了。直接把静态资源扔给cdn，cdn会自动根据用户侧网络分配内容服务器，以及负载均衡。只要配置一下缓存策略，保证回流流量在一个安全值里就行。花钱能解决的问题也能叫问题吗（笑）。

当然你如果要和我说ssr（服务端渲染），其实很多比较fashion的托管平台也提供ssr能力（如vercel），加钱就行了。更何况等学校教务系统都用上ssr了，估计这股潮流也过了。

关于前面同学提到了p2p等，首先这种东西只限于c/s架构。因为浏览器不提供主动监听端口的功能，只能主动发起请求，然后打开端口被动监听回传消息。另外静态资源直接让用户间明文p2p传递显然也是不安全的，一方面，JavaScript、html等文本文件极其容易被篡改，数据的一致性无法保证；另一方面，用户侧开启p2p后也可能让用户受到各种攻击，如ddos，稀奇古怪的注入等。此外，用户可能使用的是流量呐，人家运营商扣一大笔钱，你咋办喵。

并且呢，c/s架构的维护成本太高了，用户这么多平台，适配成本讲道理是不值当的，还不如花点钱弄点cdn。这种事你们可以花点钱嘛，花点儿，花不了多少。

然后是大头动态侧，也就是后端服务。后端服务么，又是外包，肯定是人和代码有一个能跑就行，谁管你并发性能。估计一开始么整个服务都是单线程的，毕竟不用管竞态、I/O复用、原子操作balabala，一顿哐哐哐写业务代码就行。后来发现不行，就加了个池子。现在选课是，请求发过去以后，不会立刻回复结果，而是等一个请求池的请求全部处理完，再返回结果。这是一种很廉价但是又效果很好的优化方法。毕竟用户侧对结果返回的实时性要求并不高，几秒的等待是完全可以接受的。并且依然不改变程序单线程的事实，“保证了数据的一致性”（笑）。

关于session在高并发下老失效我怀疑是不是一开始用户数据全怼内存里了，然后oom内存爆了，服务自动重启了，最后大家都一直在登录与登录中循环（笑）。改进么，内存不够就加两条吧，花点钱，也花不了多少。

至于验证码这种东西，这个可以抽出来做一个独立的多线程服务，反正也和主业务不咋耦合，这样依然可以保证原来服务单线程的“强鲁棒性”。当然了，现在有sso了，解决方案也可以是大力推进sso，压力扔给sso那边就行。（实际上e服务的并发能力上次5月份约核酸的时候也看到了，就不吐槽了）

最后呢，我想说我一直是一个比较摆烂的人，不会像前面同学kafka、redis、并发系统，直接推翻全部重来这样激进，能在原系统上修修改改就修修改改吧。毕竟重复造轮子风险还是蛮大的，一个是原来业务如果复杂的话，重构是一个很庞大费钱的工程；另一方面整体重构不一定能弄到更高水平的工程师，项目水平更烂了也不好说。现代软件工程本就不是上世纪那种一旦交付，就再也不更新了；而是永远在上一个版本上迭代，以最低的成本去实现最新的需求可能更符合现代软件工程哲学。